generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model Project {
  id            String   @id @default(cuid())
  name          String
  description   String   @default("")
  instruction   String   @default("")
  feishuLink    String?
  workspacePath String   @default("")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tasks    Task[]
  context  ContextItem[]
  outputs  OutputArtifact[]
}

model Task {
  id             String   @id @default(cuid())
  projectId      String
  name           String
  description    String   @default("")
  type           String   @default("one_time") // periodic | one_time | proactive
  status         String   @default("pending")  // pending | running | completed | awaiting_input
  sessionId      String?  // Claude Code session UUID
  scheduleConfig String?  // JSON string for periodic config
  nextRunAt      DateTime?
  lastRunAt      DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  project  Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  messages Message[]
  outputs  OutputArtifact[]

  @@index([projectId])
  @@index([status])
  @@index([nextRunAt])
}

model Message {
  id        String   @id @default(cuid())
  taskId    String
  role      String   // user | agent | system
  content   String
  metadata  String?  // JSON string
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
}

model ContextItem {
  id        String   @id @default(cuid())
  projectId String
  name      String
  type      String   // file | url | feishu_folder | text_note
  content   String
  metadata  String?  // JSON string
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
}

model OutputArtifact {
  id        String   @id @default(cuid())
  projectId String
  taskId    String?
  name      String
  type      String   // report | document | data | code | other
  content   String
  summary   String?
  metadata  String?  // JSON string
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  task    Task?   @relation(fields: [taskId], references: [id], onDelete: SetNull)

  @@index([projectId])
  @@index([taskId])
}

model UserTodo {
  id          String   @id @default(cuid())
  projectId   String
  taskId      String
  type        String   // ASK_USER_CONTEXT | ASK_USER_CONFIRM
  query       String
  suggestion  String?  // Project Agent's suggestion (e.g. where to add context)
  priority    String   @default("medium") // high | medium | low
  resolved    Boolean  @default(false)
  response    String?  // User's reply
  createdAt   DateTime @default(now())
  resolvedAt  DateTime?

  @@index([projectId])
  @@index([taskId])
  @@index([resolved])
}

model ProjectAgent {
  id          String   @id @default(cuid())
  projectId   String   @unique
  pid         Int?     // OS process ID
  status      String   @default("stopped") // running | stopped | crashed
  lastHeartbeat DateTime?
  sessionId   String?  // Claude Code session ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([status])
}
